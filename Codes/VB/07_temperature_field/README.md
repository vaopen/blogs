# 二维有限差分法温度场模拟程序

本程序题目源于材成专业必修课程 《计算机编程与实践》，使用 VB 实现铸件凝固过程温度场数值模拟程序，最低要求实现以下功能

-  前处理程序
   -  可以将指定大小区域（$0.5m \times 0.5m$）以等网格（$\Delta x = \Delta y$）进行划分
   -  并可以自定义网格属性（铸件、铸型）—— 例如可以点选赋值，参考五子棋程序
   -  可以将绘制好的网格、材料属性等相关数据导出，供后处理程序使用
-  计算及后处理程序
   -  可以接受前处理程序导出的文件，并正确显示
   -  可以设置单元初始温度、导热系数等非材料属性模拟相关参数
   -  可以计算温度场
   -  可以选择计算潜热或不计算潜热
   -  可以将温度场以云图的方式显示（设置合理的彩色温度标尺）
   -  可以输出预设点的温度曲线（设置合理的坐标）

### 依赖

-  Microsoft Common Diglog Control 6.0
-  Microsoft Windows Common Controls 5.0

前后处理程序均依赖以上部件，请保证预先装载后再使用

## 用法简述

### 前处理

-  导入数据

   支持导入之前画好的数据，以进行修改

-  生成网格

   根据 $\Delta x$ 与 $\Delta y$ 对网格进行划分，以便后续对材料进行设置

   将 $500 \times 500$ 的区域划分为网格时，其内部结点划分为等网格，最外层长（宽）为内部结点的一半大小，这样保证了计算时两结点温度中心距离 $d$ 的一致性

-  细致划分

   将已经在大网格内画好的图形使用更细小的网格进行划分，避免在小网格内直接画瞎了（最崩溃的是画了半天不小心点到了重新划分……关键是我还重复这种蠢操作五六次）

-  区域选择

   默认全铸型（不允许空白的存在，以保证最外圈就是边界，否则网格划分等方面需要修改）

   可利用以下两种方式对区域进行选中

   > 圆形的选中使用格点的中心点是否在圆内进行判断，因为当半径相对于格子足够大的时候，格点中心点是否在圆内大概可以表征该格点是否有一半以上面积在圆内，而且该操作性能影响并不大

   -  输入选择

      在输入框输入所需参数后，点击选择按钮对区域进行选择，但是由于使用起来并不方便，如非对圆形区域进行选中，不推荐

      > 圆形使用 `mm` 作为单位，不依赖于网格的划分后格点的大小（只影响精度），输入选中会有更高的精度

   -  快捷键选择

      主流方法是使用**快捷键 Ctrl 、 Shift 、 Alt 快速选中区域**，具体使用方法如下

      > 快捷键的使用方法启发于 Windows 文件管理系统，操作方式类似于该操作，并针对本应用进行了部分优化，熟悉 Windows 文件操作的小伙伴应该可以很快上手~

      -  按住 Ctrl 后，之前选中的区域不消失，新选中的区域会与原区域取并选中
      -  按住 Shift 后，上次选中的点会作为起点，新的点作为终点，选中连续的一个矩形
      -  按住 Alt 后，上次选中的点的中心会作为圆心，新的点的中心与圆心之间的距离作为半径，选中一个圆形区域
      -  同时按住 Ctrl 和 Shift Or Alt，emmmmm 试一下吧（反正不会爆炸:joy:）~

*  指定材料

   指定材料时可利用反向填充选项，这样就可以对未选中区域填充目标材料

   另外，简单地支持了下**右键取消选中区域**、**中键快速填充**的功能

   > 该处可以增加保存该次选中区域的外接矩形的的左上角与右下角点机制，以减小重绘区域

*  材料选择

   程序自动会从材料文件 `data/params.dat` 中读取并填入相应列表，可以在文件中手动添加（注意单位哦！）

*  导出数据

   将已经画好的图形导出为通用的格式，前后处理均可再次读取

   > 导出的矩阵应为看到的矩阵的转置，但这并不影响前后处理的传递，事实上我们的数据一直就是这样存储着的，而且这样处理起来也更方便

*  导出云图

   将已经画好的图形导出为图片，不可再次导入

### 后处理

-  参数设置

   注意对时间步的计算，程序内辅助计算最大时间步（为保证足够小又乘了 0.9 ）

-  设置探针

   可通过温度探针对某个结点温度进行记录，以便后续绘制温度曲线

   窗口打开后，可通过点选方式辅助选中结点，并可以选择后续是否显示探针图形（一个小靶子，网格太小就看不清了……）

-  计算

   对后续温度场进行模拟计算，可中途暂停、继续，**目前性能较低，待优化**

-  显示温度曲线

   对探针处温度进行绘制，可在运行时手动刷新

   鼠标在图像区域移动时，会显示该时间步下的温度值，并画出辅助线（可使用刷新按钮去掉）

## 计算公式

由于是二维，所以所有需要使用体积进行计算的地方均使用面积代替，接触面也变成了接触宽度，最后计算所得的热量单位应为 $J/m$ ，但由于单元热平衡法两侧单位一致，直接计算即可

### 有限差分法

使用单元热平衡法对 $s \times w$ 大小的微元进行分析

考察任意两个相邻结点之间的热交换，令 $s$ 为相邻两结点间的接触宽度， $w$ 为目的结点在沿两结点连线方向的厚度， $s \times w$ 应为该微元的面积（“体积”）

> 由于相邻结点之间的传热是相反的，可计算一次后传入热量缓冲矩阵，计算时间可以减半（可能后续完成，不过一般说完我都不做了:joy:）

-  从相邻结点获得的热量 $Q_k = k \frac{T' - T}{d} \cdot s \cdot \Delta \tau$
-  从空气获得的热量 $Q_h = h (T_{AIR} - T) \cdot s \cdot \Delta \tau$

故总热量 $Q$ 应为上下左右四方向传热加和

又 $Q = c m \Delta T = c \rho s w \Delta T$ ，可计算出最终的热量

### 铸件-铸型界面模型

可计算得 当量 $k$ 应为 $\frac{2 k_1 k_2}{k_1 + k_2}$ ，即 计算铸件铸型之间换热时使用该 $k$ 替换原有 $k$

### 潜热的计算

由于金属（合金）凝固时会释放潜热，会延缓结晶温度区间的温度变化，故需要一定处理手段，这里使用温度（热量）补偿法，利用潜热矩阵记录剩下的潜热

由于 $c \Delta T = L$ ，故 $Q_L = c m \Delta T = c \rho s w \Delta T$

在凝固点（液相线）下，根据潜热抵消已释放的热量部分

### 收敛判据

-  $\frac{k_M \Delta t}{c_M \rho_M d^2} \leq \frac{1}{4}$
-  $\frac{k_S \Delta t}{c_S \rho_S d^2} \leq \frac{1}{4 (1 + B)}$

其中 $B = \frac{h \cdot s}{k_S}$

## 已知的问题

-  [ ] 细致网格运行极慢，$5 \times 5$ 大小的网格基本需要每秒跑模拟的一秒， 3000s 的预计跑一小时，可通过以下方案“解决”
   -  优化算法，暂时是没有太好的优化方案，而且改起来可读性并不会太好，本程序并不投入生产环境，并不会做牺牲太大可读性的性能优化
      > 已经尝试做了对 SWD 的预获取进行优化，该处也理应优化（且不说判断的时间复杂度，过程的调用反复入栈出栈会带来较大开销），但是当前改之后的代码会看起来更加繁冗（多了 6 个矩阵），故暂时保留原方法，待想到更优的解决方案再优化（自定义 `Type` 数组的初始化貌似有些问题，所以没能合成一个矩阵）
   -  使用 C++ 编写核心计算模块，但是可能需要耗费一点时间
   -  **编译成 `.exe` 后再运行，目测提速 `20%`**
   -  使用更快的电脑，嗯，这个提升最快，我的笔记本（`4200U`）上跑一个小时的，机房（`7700`）大概只需要 5min ，提速 `10` 倍左右
   -  使用其他语言的类来完成啦，只用一个对象数组来完成，这样比设置多个数组的性能应该会高些，但如果是 VB 的话，还是不太喜欢用它的类的
-  [ ] 后处理切换显示模式那里有点小小问题，暂时搁置下下（下下下下下...）
-  [ ] 前处理增加新的输入模式后可能会与快捷键模式有点冲突，并且逻辑上并不是太好处理，所以会有些不太容易预料的问题

## 注意事项

-  前处理长度使用 $mm$ 作为单位，后处理为保证处理的易行性，均使用国际单位制，即长度使用 $m$ 作为单位
-  后处理色标那里参考学长的建议使用 HSV 色彩，以使色标尽量均匀化，但是在中间区域（黄、绿）色部分肉眼区分度并不高，而我们的示例温度主要分布在中间区域，故使用 Sigmoid 函数提高中间部分的区分度（Sigmoid 函数图像自行百度），当前参数仅考虑示例内容，故使得两端区分度降低，可根据程序内注释部分修改参数优化色标，以适应具体应用场景

# Refs

-  黄阿童学长提供的例程、资料以及理论讲解
-  《大型铸件凝固进程的数字模拟》 郭可讱

---

© 2019 SigureMo [notev](https://github.com/SigureMo/notev/tree/master/Codes/VB/07_temperature_field)
